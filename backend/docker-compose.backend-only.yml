version: '3.9'

# =========================================================================
# NumzTrak Backend-Only Production Stack (Oracle Cloud / Any Linux Host)
# =========================================================================
# Features:
#   - Traccar GPS/Fleet Tracking Server
#   - Fuel API (Node.js microservice)
#   - PostgreSQL (Fuel API database)
#   - MySQL (Traccar database)
#   - Nginx Reverse Proxy (HTTPS/SSL)
#
# No frontend service; suitable for:
#   - Hosting backend APIs only
#   - Netlify-hosted frontend connecting to these APIs
#   - Production deployments on Oracle Cloud, AWS, DigitalOcean, etc.
#
# Startup: docker-compose -f docker-compose.backend-only.yml up -d
# =========================================================================

services:
  # =========================================================================
  # DATABASE LAYER
  # =========================================================================

  traccar-mysql:
    image: mysql:8.0
    container_name: numztrak-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-traccar_root_pass}
      MYSQL_DATABASE: traccar
      MYSQL_USER: traccar
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-traccar_pass}
    volumes:
      - traccar_mysql_data:/var/lib/mysql
    networks:
      - numztrak-network
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      timeout: 20s
      retries: 10
    ports:
      - '3306:3306'  # Exposed for monitoring/backups only

  fuel-postgres:
    image: postgres:15-alpine
    container_name: numztrak-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: numztrak_fuel
      POSTGRES_USER: numztrak
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-numztrak_pass}
    volumes:
      - fuel_postgres_data:/var/lib/postgresql/data
    networks:
      - numztrak-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U numztrak -d numztrak_fuel']
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - '5432:5432'  # Exposed for monitoring/backups only

  # =========================================================================
  # CORE BACKEND SERVICES
  # =========================================================================

  traccar-server:
    image: traccar/traccar:latest
    container_name: numztrak-traccar
    restart: unless-stopped
    depends_on:
      traccar-mysql:
        condition: service_healthy
    environment:
      TRACCAR_DATABASE_URL: jdbc:mysql://traccar-mysql:3306/traccar?useSSL=false&allowPublicKeyRetrieval=true
      TRACCAR_DATABASE_USER: traccar
      TRACCAR_DATABASE_PASSWORD: ${MYSQL_PASSWORD:-traccar_pass}
    volumes:
      - traccar_logs:/opt/traccar/logs
      - ./conf/traccar.xml:/opt/traccar/conf/traccar.xml:ro
      - ./cert.pem:/opt/traccar/conf/cert.pem:ro
      - ./key.pem:/opt/traccar/conf/key.pem:ro
    networks:
      - numztrak-network
    # GPS Protocol ports (exposed for GPS devices to connect directly)
    # Adjust these based on which protocols you use
    ports:
      - '5001:5001'   # Traccar protocol
      - '5002:5002'   # GL200 protocol
      - '5003:5003'   # Xexun protocol
      - '5005:5005'   # TK103 protocol
      - '5006:5006'   # TK103 binary protocol
      - '5009:5009'   # Teltonika protocol
      - '5013:5013'   # Neoway protocol
      - '5020:5020'   # TK103-2 protocol
      - '5055:5055'   # Siptech protocol
      # Add more GPS protocols as needed based on traccar.xml config
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:8082/api/server']
      interval: 30s
      timeout: 10s
      retries: 3

  fuel-api:
    image: numztrak/fuel-api:latest
    container_name: numztrak-fuel-api
    restart: unless-stopped
    depends_on:
      fuel-postgres:
        condition: service_healthy
      traccar-mysql:
        condition: service_healthy
    environment:
      # Database connections
      DATABASE_URL: postgresql://numztrak:${POSTGRES_PASSWORD:-numztrak_pass}@fuel-postgres:5432/numztrak_fuel
      TRACCAR_MYSQL_HOST: traccar-mysql
      TRACCAR_MYSQL_PORT: 3306
      TRACCAR_MYSQL_DATABASE: traccar
      TRACCAR_MYSQL_USER: traccar
      TRACCAR_MYSQL_PASSWORD: ${MYSQL_PASSWORD:-traccar_pass}
      # App configuration
      NODE_ENV: production
      PORT: 3001
      SESSION_SECRET: ${SESSION_SECRET:-change_me_in_production}
      # CORS - Allow Netlify preview and custom domain (comma-separated)
      CORS_ORIGIN: ${CORS_ORIGIN:-https://app.numz.site,https://rad-cactus-ca0409.netlify.app}
      # Optional: for external Traccar connections
      TRACCAR_SERVER_URL: ${TRACCAR_SERVER_URL:-http://traccar-server:8082}
    networks:
      - numztrak-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://127.0.0.1:3001/health']
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================================
  # REVERSE PROXY / GATEWAY
  # =========================================================================

  numztrak-nginx:
    image: nginx:alpine
    container_name: numztrak-nginx
    restart: unless-stopped
    depends_on:
      - traccar-server
      - fuel-api
    ports:
      - '80:80'    # HTTP (redirects to HTTPS)
      - '443:443'  # HTTPS (production traffic)
    volumes:
      - ./nginx/nginx-backend-only.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx_logs:/var/log/nginx
    networks:
      - numztrak-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', '--no-check-certificate', 'https://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3

# =========================================================================
# VOLUMES (Persistent Data Storage)
# =========================================================================

volumes:
  traccar_mysql_data:
    driver: local
  fuel_postgres_data:
    driver: local
  traccar_logs:
    driver: local
  nginx_logs:
    driver: local

# =========================================================================
# NETWORKS
# =========================================================================

networks:
  numztrak-network:
    driver: bridge
